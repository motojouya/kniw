(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[973],{7156:function(e,t,r){(window.__NEXT_P=window.__NEXT_P||[]).push(["/battle",function(){return r(1027)}])},1027:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return en}});var s=r(5893),l=r(7294),i=r(9332),n=r(7747),a=r(4e3),c=r(6236),u=r(4271),h=r(4670),o=r(5422),x=r(1664),d=r.n(x),j=r(5541),f=r(1039),m=r(6324);let p=()=>{let{battleRepository:e}=(0,m.j)(),t=(0,f.useLiveQuery)(()=>e.list(),[]);return(0,s.jsxs)(n.xu,{children:[(0,s.jsx)(d(),{href:{pathname:"/"},children:(0,s.jsx)("a",{children:"戻る"})}),(0,s.jsx)(n.xu,{children:(0,s.jsxs)(j.aV,{children:[(0,s.jsx)(j.HC,{children:(0,s.jsx)(d(),{href:{pathname:"battle",query:{title:"__new"}},children:(0,s.jsx)("a",{children:"新しく作る"})})},"battle-new"),t&&t.map((e,t)=>(0,s.jsx)(j.HC,{children:(0,s.jsx)(d(),{href:{pathname:"battle",query:{title:e}},children:(0,s.jsx)("a",{children:e})})},"battle-".concat(t)))]})})]})};var v=r(1163),w=r(7536),b=r(1001),V=r(8020),I=r(6529),_=r(3090),N=r(2916),y=r(3418),g=r(7627),S=r(666);let k=e=>async(t,r,s,l)=>{let i=(0,g.DG)(t,r,s),n=(0,g.BL)(i,l,(0,S.NN)());i.turns.push(n);let a=(0,g.k_)(i);return i.turns.push((0,g.Dc)(i,a.restWt,l,(0,S.NN)())),await e.save(i),i},O=()=>{let{battleRepository:e}=(0,m.j)(),t=(0,v.useRouter)(),[r,i]=(0,l.useState)(""),{handleSubmit:c,register:u,formState:{errors:h,isSubmitting:o}}=(0,w.cI)(),[x,j]=(0,l.useState)(null),[f,p]=(0,l.useState)(null),g=async r=>{let s=[],{title:l}=r;if(l||s.push("titleを入力してください"),x||s.push("home partyを入力してください"),f||s.push("visitor partyを入力してください"),s.length>0){i(s.join("\n"));return}let n=await k(e)(l,x,f,new Date);await t.push({pathname:"battle",query:{title:n.title}})};return(0,s.jsxs)(n.xu,{p:4,children:[(0,s.jsx)(d(),{href:{pathname:"battle"},children:(0,s.jsx)("a",{children:"戻る"})}),(0,s.jsx)(a.x,{children:"This is the battle page"}),(0,s.jsxs)("form",{onSubmit:c(g),children:[r&&(0,s.jsx)(b.J1,{children:r}),(0,s.jsxs)(V.NI,{isInvalid:!!h.title,children:[(0,s.jsx)(I.l,{htmlFor:"title",children:"title"}),(0,s.jsx)(_.I,{id:"title",placeholder:"title",...u("title")}),(0,s.jsx)(b.J1,{children:h.title&&h.title.message})]}),(0,s.jsx)(y.R,{type:"HOME",party:x,setParty:j}),(0,s.jsx)(y.R,{type:"VISITOR",party:f,setParty:p}),(0,s.jsx)(N.z,{colorScheme:"teal",isLoading:o,type:"submit",children:"Start Battle"})]})]})};var E=r(6312),C=r(1731),D=r(8371),T=r(2757),R=r(3243),W=r(1604),H=r(6973),X=r(7442),z=r(5958);let L="DO_NOTHING";class A{constructor(e){this.message=e}}let M=W.z.object({skillName:W.z.string().min(1),receiversWithIsVisitor:W.z.array(W.z.object({value:W.z.string().min(1)}))}),B=e=>({value:"".concat(e.name,"__").concat((0,X.oR)(e.isVisitor)),label:"".concat(e.name,"(").concat((0,X.oR)(e.isVisitor),")")}),P=(e,t)=>{let r=e.match(/^(.*)__(HOME|VISITOR)$/);if(!r)throw Error("no match");let s=r[1];if(!s)throw Error("no name");let l=r[2];if("HOME"!==l&&"VISITOR"!==l)throw Error("isVisitorStr must be HOME or VISITOR. (".concat(l,")"));let i="VISITOR"===l,n=t.find(e=>e.name===s&&e.isVisitor===i);return n||new H.Xs(s,"charactor","".concat(s,"というcharactorは存在しません"))},F=(e,t)=>{let{skillName:r}=e;if(r===L)return null;let s=z.U.get(r);if(!s)return new H.Xs(r,"skill","".concat(r,"というskillは存在しません"));let l=new Set(e.receiversWithIsVisitor.map(e=>e.value));if(l.size!==e.receiversWithIsVisitor.length)return new A("同じキャラクターを複数回えらべません");let i=[];for(let r of e.receiversWithIsVisitor){let e=P(r.value,t);if(e instanceof H.Xs)return e;i.push(e)}return{skill:s,receivers:i}};var q=r(9199),J=r(4168),U=r(2457);let Z=(e,t)=>async(r,s,l,i)=>{let n=F(l,i.sortedCharactors);if(n instanceof H.Xs||n instanceof A)return n;if(!e.confirm("実行していいですか？"))return new o.vW("Cancelされました");if(null===n)r.turns.push((0,g.en)(r,s,new Date));else{let e=n.skill,t="SKILL_TO_FIELD"===e.type?(0,g.d)(r,s,e,new Date,(0,S.NN)()):(0,g.B7)(r,s,e,n.receivers,new Date,(0,S.NN)());r.turns.push(t)}if(r.result=(0,g.fe)(r),r.result!==g.Ai)return await t.save(r),null;let a=(0,g.k_)(r);if(r.turns.push((0,g.Dc)(r,a.restWt,new Date,(0,S.NN)())),r.result=(0,g.fe)(r),r.result!==g.Ai)return await t.save(r),null;for(;(0,J.V)(U.sleep,a)&&(r.turns.push((0,g.en)(r,a,new Date)),r.result=(0,g.fe)(r),r.result===g.Ai&&(a=(0,g.k_)(r),r.turns.push((0,g.Dc)(r,a.restWt,new Date,(0,S.NN)())),r.result=(0,g.fe)(r),r.result===g.Ai)););return await t.save(r),null},$=(e,t)=>async(r,s,l)=>{if(!t.confirm("降参してもよいですか？"))return new o.vW("降参していません");let i=(0,g.mR)(r,s,l);return r.turns.push(i),await e.save({...r,result:s.isVisitor?g.ZV:g.Eh}),null},G=(e,t,r,s,l,i)=>{let n=P(s,l.sortedCharactors);if(n instanceof H.Xs)return n;let a=(0,g.B7)(e,t,r,[n],i,(0,S.q6)()),c=a.sortedCharactors.find(e=>e.isVisitor===n.isVisitor&&e.name===n.name);return{receiver:n,survive:!!c}},Q=e=>{if(e===L)return 0;let t=z.U.get(e);return t&&t.receiverCount?t.receiverCount:0},K=e=>{let{battle:t}=e,r="".concat(t.home.name,"(HOME) vs ").concat(t.visitor.name,"(VISITOR)");switch(t.result){case g.ZV:return(0,s.jsx)(a.x,{children:"".concat(r," HOME側の勝利")});case g.Eh:return(0,s.jsx)(a.x,{children:"".concat(r," VISITOR側の勝利")});case g.$C:return(0,s.jsx)(a.x,{children:"".concat(r," 引き分け")});default:return(0,s.jsx)(a.x,{children:r})}},Y=e=>{let{battle:t,actor:r,lastTurn:i,skill:a,index:c,getValues:u,register:h}=e,o="receiversWithIsVisitor.".concat(c,".value"),[x,d]=(0,l.useState)(null),j=i.sortedCharactors.map(B);return(0,s.jsxs)(n.xu,{children:[(0,s.jsxs)(V.NI,{children:[(0,s.jsx)(I.l,{htmlFor:o,children:"receiver"}),(0,s.jsx)(C.P,{...h(o,{onBlur:()=>{let e=u(o),s=G(t,r,a,e,i,new Date);if(s instanceof H.Xs){d(null);return}let{survive:l,receiver:n}=s;if(!l){d("".concat(n.name," will dead"));return}d(n)}}),placeholder:"receiver",children:j.map(e=>(0,s.jsx)("option",{value:e.value,children:e.label},"".concat(e.value)))})]}),(0,s.jsx)(n.xu,{children:x&&("string"==typeof x?x:(0,s.jsx)(R.i,{charactor:x}))})]})},ee=e=>{let{battle:t,actor:r}=e,{battleRepository:l,dialogue:i}=(0,m.j)();return(0,s.jsx)(N.z,{type:"button",onClick:()=>$(l,i)(t,r,new Date),children:"降参"})},et=e=>{let{actor:t,replace:r,getValues:l,register:i,errors:n}=e,a=(0,X.SM)(t),c=a.filter(e=>e.mpConsumption<=t.mp).filter(e=>!(0,J.V)(U.silent,t)||e.magicType===q.LB).map(e=>({value:e.name,label:e.name}));return c.push({value:L,label:"何もしない"}),(0,s.jsxs)(V.NI,{isInvalid:!!n.skillName,children:[(0,s.jsx)(I.l,{htmlFor:"skill",children:"skill"}),(0,s.jsx)(C.P,{...i("skillName",{onBlur:()=>{let e=l("skillName"),t=Q(e);r(Array(t).fill(""))}}),placeholder:"skill",children:c.map(e=>(0,s.jsx)("option",{value:e.value,children:e.label},"".concat(e.value)))}),(0,s.jsx)(b.J1,{children:!!n.skillName&&n.skillName.message})]})},er=e=>{let{battle:t}=e,{battleRepository:r,dialogue:i}=(0,m.j)(),c=(0,g.aY)(t),u=(0,g.k_)(t),{handleSubmit:h,register:x,getValues:f,formState:{errors:p,isSubmitting:v},control:V}=(0,w.cI)({resolver:(0,E.F)(M)}),{fields:I,replace:_}=(0,w.Dq)({control:V,name:"receiversWithIsVisitor"}),[y,S]=(0,l.useState)(""),k=async e=>{let s=await Z(i,r)(t,u,e,c);if(s instanceof H.Xs){S("入力してください");return}if(s instanceof A||s instanceof o.vW){S(s.message);return}_([])},O=u.isVisitor?(0,s.jsx)(D.Vp,{children:"VISITOR"}):(0,s.jsx)(D.Vp,{children:"HOME"}),C=z.U.get(f("skillName"));return(0,s.jsxs)(n.xu,{p:4,children:[(0,s.jsx)(d(),{href:{pathname:"battle"},children:(0,s.jsx)("a",{children:"戻る"})}),(0,s.jsx)(a.x,{children:"This is the battle page"}),t.result!==g.Ai&&(0,s.jsx)(N.z,{type:"button",onClick:()=>r.exportJson(t,""),children:"Export"}),(0,s.jsx)(K,{battle:t}),t.result===g.Ai&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("form",{onSubmit:h(k),children:[y&&(0,s.jsx)(b.J1,{children:y}),t.result===g.Ai&&(0,s.jsx)(ee,{battle:t,actor:u}),(0,s.jsxs)(n.xu,{as:"dl",children:[(0,s.jsx)(T.X,{as:"dt",children:"battle title"}),(0,s.jsx)(a.x,{as:"dd",children:t.title})]}),(0,s.jsxs)(a.x,{children:["".concat(u.name,"のターン"),O]}),(0,s.jsx)(et,{actor:u,getValues:f,register:x,errors:p,replace:_}),(0,s.jsx)(j.aV,{children:I.map((e,r)=>(0,s.jsx)(j.HC,{children:C&&(0,s.jsx)(Y,{battle:t,actor:u,lastTurn:c,skill:C,getValues:f,register:x,index:r})},"receiversWithIsVisitor.".concat(r)))}),(0,s.jsx)(N.z,{colorScheme:"teal",isLoading:v,type:"submit",children:"実行"})]}),(0,s.jsx)(n.xu,{children:(0,s.jsx)(j.aV,{children:c.sortedCharactors.map(e=>(0,s.jsx)(j.HC,{children:(0,s.jsx)(R.i,{charactor:e})},"CharactorDetail-".concat(e.name,"-").concat((0,X.oR)(e.isVisitor))))})})]})]})};var es=r(5618),el=r(4969);let ei=e=>{let{battleTitle:t}=e,{battleRepository:r}=(0,m.j)(),l=(0,f.useLiveQuery)(()=>r.get(t),[t]);return l instanceof el.m||l instanceof H.Xs||l instanceof es.hi||l instanceof H.$b||l instanceof g.pZ?(0,s.jsxs)(n.xu,{children:[(0,s.jsx)(a.x,{children:l.message}),(0,s.jsx)(d(),{href:{pathname:"battle"},children:(0,s.jsx)("a",{children:"戻る"})})]}):l?(0,s.jsx)(er,{battle:l}):(0,s.jsxs)(n.xu,{children:[(0,s.jsx)(d(),{href:{pathname:"battle"},children:(0,s.jsx)("a",{children:"戻る"})}),(0,s.jsx)(a.x,{children:"".concat(t,"というbattleは見つかりません")})]})};var en=()=>{let e=(0,i.useSearchParams)(),t=e.get("title"),[r,x]=(0,l.useState)(null);if((0,l.useEffect)(()=>{(async()=>{let e=await (0,h.a)(),t=await (0,u.h4)(e),r=await (0,c.h4)(e);x({partyRepository:t,battleRepository:r})})()},[]),!r)return(0,s.jsx)(n.xu,{children:(0,s.jsx)(a.x,{children:"loading..."})});let d={...r,dialogue:o.OR};return t?"__new"===t?(0,s.jsx)(m._,{io:d,children:(0,s.jsx)(O,{})}):(0,s.jsx)(m._,{io:d,children:(0,s.jsx)(ei,{battleTitle:t})}):(0,s.jsx)(m._,{io:d,children:(0,s.jsx)(p,{})})}}},function(e){e.O(0,[905,154,492,774,888,179],function(){return e(e.s=7156)}),_N_E=e.O()}]);