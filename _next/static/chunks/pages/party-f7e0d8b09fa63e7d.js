(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[141],{6698:function(e,n,r){(window.__NEXT_P=window.__NEXT_P||[]).push(["/party",function(){return r(7635)}])},7635:function(e,n,r){"use strict";r.r(n),r.d(n,{default:function(){return R}});var t=r(5893),a=r(7294),s=r(9332),i=r(7747),c=r(4e3),o=r(4533);let l="party",h=e=>async n=>e.save(l,n.name,(0,o.KD)(n)),m=e=>async n=>{let r=await e.get(l,n);return r?(0,o.r7)(r):null},u=e=>async n=>e.remove(l,n),p=e=>async()=>e.list(l),d=e=>async(n,r)=>e.exportJson(l,n,r),x=async e=>(await e.checkNamespace(l),{save:h(e),list:p(e),get:m(e),remove:u(e),exportJson:d(e)});var f=r(8429),g=r(1163),y=r(1664),j=r.n(y),w=r(1077),b=r(5332),v=r(7536),L=r(1001),_=r(2757),C=r(8020),q=r(6529),X=r(3090),k=r(5541),E=r(2916),N=r(1039),S=r(1581),J=r.n(S),M=r(8227),$=r(4969),z=r(7442),I=r(524);let H={type:"object",properties:{name:{type:"string",minLength:1,errorMessage:{minLength:"username field is required"}},race:{type:"string",minLength:1,errorMessage:{minLength:"username field is required"}},blessing:{type:"string",minLength:1,errorMessage:{minLength:"username field is required"}},clothing:{type:"string",minLength:1,errorMessage:{minLength:"username field is required"}},weapon:{type:"string",minLength:1,errorMessage:{minLength:"username field is required"}}},required:["name","race","blessing","clothing","weapon"],additionalProperties:!1},P=e=>({name:e.name,race:e.race.name,blessing:e.blessing.name,clothing:e.clothing.name,weapon:e.weapon.name}),F=e=>{let n=new(J()),r=n.compile(H);if(!r(e)){let{errors:e}=r;return console.debug(e),new M.$b(e,"charactorのデータではありません")}let{name:t}=e,a=(0,I.tI)(e.race);if(!a)return new M.Xs(e.race,"race","".concat(e.race,"という種族は存在しません"));let s=(0,I.ez)(e.blessing);if(!s)return new M.Xs(e.blessing,"blessing","".concat(e.blessing,"という祝福は存在しません"));let i=(0,I.FL)(e.clothing);if(!i)return new M.Xs(e.clothing,"clothing","".concat(e.clothing,"という装備は存在しません"));let c=(0,I.i7)(e.weapon);if(!c)return new M.Xs(e.weapon,"weapon","".concat(e.weapon,"という武器は存在しません"));let o=(0,z.Gu)(t,a,s,i,c);if(o instanceof $.m)return o;let l={name:t,race:a,blessing:s,clothing:i,weapon:c,statuses:[],hp:0,mp:0,restWt:0},h=(0,z.SR)(l);return l.hp=h.MaxHP,l.restWt=h.WT,l};var T=r(5618);let V={type:"object",properties:{name:{type:"string",minLength:1,errorMessage:{minLength:"username field is required"}},charactors:{type:"array",items:H}},required:["name","charactors"]},D=e=>({name:e.name,charactors:e.charactors.map(P)}),G=e=>{let n=new(J()),r=n.compile(V);if(!r(e)){let{errors:e}=r;return console.debug(e),new M.$b(e,"partyのformデータではありません")}let{name:t}=e,a=[];for(let n of e.charactors){let e=F(n);if(e instanceof M.Xs||e instanceof $.m||e instanceof M.$b)return e;a.push(e)}let s=(0,T.Gu)(t,a);return s instanceof T.hi?s:{name:t,charactors:a}},K=(e,n)=>async r=>{let t=G(r);if(t instanceof M.Xs||t instanceof $.m||t instanceof M.$b||t instanceof T.hi)return t;if(n){let n=await e.list();if(n.includes(t.name))return new M.KC(t.name,"party","".concat(t.name,"というpartyは既に存在します"))}return await e.save(t),null},W=e=>{let{exist:n,partyForm:r,inoutButton:s,store:o}=e,l=(0,g.useRouter)(),{handleSubmit:h,register:m,getValues:u,formState:{errors:p,isSubmitting:d},control:x}=(0,v.cI)({resolver:(0,b.G)(V),defaultValues:r}),{fields:f,append:y,remove:N}=(0,v.Dq)({control:x,name:"charactors"}),[S,J]=(0,a.useState)({error:!1,message:""}),z=async e=>{let r=await K(o,!n)(e);r instanceof M.Xs||r instanceof $.m||r instanceof M.$b||r instanceof T.hi||r instanceof M.KC?J({error:!0,message:r.message}):n?J({error:!1,message:"保存しました"}):await l.push({pathname:"party",query:{name:e.name}})},I=async e=>{window.confirm("削除してもよいですか？")&&(await o.remove(e),await l.push({pathname:"party"}))};return(0,t.jsxs)(i.xu,{p:4,children:[(0,t.jsx)(j(),{href:{pathname:"party"},children:(0,t.jsx)("a",{children:"戻る"})}),(0,t.jsx)(c.x,{children:"This is the party page"}),s,(0,t.jsxs)("form",{onSubmit:h(z),children:[S.message&&(S.error?(0,t.jsx)(L.J1,{children:S.message}):(0,t.jsx)(c.x,{children:S.message})),n?(0,t.jsxs)(i.xu,{as:"dl",children:[(0,t.jsx)(_.X,{as:"dt",children:"party name"}),(0,t.jsx)(c.x,{as:"dd",children:r.name})]}):(0,t.jsxs)(C.NI,{isInvalid:!!p.name,children:[(0,t.jsx)(q.l,{htmlFor:"name",children:"name"}),(0,t.jsx)(X.I,{id:"name",placeholder:"name",...m("name")}),(0,t.jsx)(L.J1,{children:p.name&&p.name.message})]}),(0,t.jsx)(k.aV,{children:f.map((e,n)=>(0,t.jsx)(k.HC,{children:(0,t.jsx)(w.g,{register:m,getValues:u,remove:N,errors:p,index:n})},"charactor-".concat(n)))}),(0,t.jsx)(E.z,{type:"button",onClick:()=>y({name:"",race:"",blessing:"",clothing:"",weapon:""}),children:"Hire"}),(0,t.jsx)(E.z,{colorScheme:"teal",isLoading:d,type:"submit",children:n?"Change":"Create"}),n&&(0,t.jsx)(E.z,{type:"button",onClick:()=>I(r.name),children:"Dismiss"})]})]})},B=e=>{let{store:n,partyName:r}=e,a=(0,N.useLiveQuery)(()=>n.get(r),[r]);if(!n.exportJson)throw Error("invalid store");return a instanceof $.m||a instanceof M.Xs||a instanceof T.hi||a instanceof M.$b?(0,t.jsxs)(i.xu,{children:[(0,t.jsx)(c.x,{children:a.message}),(0,t.jsx)(j(),{href:{pathname:"party"},children:(0,t.jsx)("a",{children:"戻る"})})]}):a?(0,t.jsx)(W,{exist:!0,partyForm:D(a),store:n,inoutButton:(0,t.jsx)(E.z,{type:"button",onClick:()=>n.exportJson&&n.exportJson(a.name,""),children:"Export"})}):(0,t.jsxs)(i.xu,{children:[(0,t.jsx)(c.x,{children:"".concat(r,"というpartyは見つかりません")}),(0,t.jsx)(j(),{href:{pathname:"party"},children:(0,t.jsx)("a",{children:"戻る"})})]})},O=e=>{let{store:n}=e,[r,s]=(0,a.useState)({name:"",charactors:[]}),i=async()=>{if(!window.confirm("取り込むと入力したデータが削除されますがよいですか？"))return;let e=await (0,f.x)();if(!e)return;let n=(0,o.r7)(e);if(n instanceof $.m||n instanceof M.Xs||n instanceof T.hi||n instanceof M.$b){window.alert(n.message);return}s(D(n))};return(0,t.jsx)(W,{exist:!1,partyForm:r,store:n,inoutButton:(0,t.jsx)(E.z,{type:"button",onClick:i,children:"Import"})})},Q=e=>{let{store:n}=e,r=(0,N.useLiveQuery)(()=>n.list(),[]);return(0,t.jsxs)(i.xu,{children:[(0,t.jsx)(j(),{href:{pathname:"/"},children:(0,t.jsx)("a",{children:"戻る"})}),(0,t.jsx)(i.xu,{children:(0,t.jsxs)(k.aV,{children:[(0,t.jsx)(k.HC,{children:(0,t.jsx)(j(),{href:{pathname:"party",query:{name:"__new"}},children:(0,t.jsx)("a",{children:"新しく作る"})})},"party-new"),r&&r.map((e,n)=>(0,t.jsx)(k.HC,{children:(0,t.jsx)(j(),{href:{pathname:"party",query:{name:e}},children:(0,t.jsx)("a",{children:e})})},"party-".concat(n)))]})})]})};var R=()=>{let e=(0,s.useSearchParams)(),n=e.get("name"),[r,o]=(0,a.useState)(null);return((0,a.useEffect)(()=>{(async()=>{let e=await (0,f.h)(),n=await x(e);o(n)})()},[]),r)?n?"__new"===n?(0,t.jsx)(O,{store:r}):(0,t.jsx)(B,{partyName:n,store:r}):(0,t.jsx)(Q,{store:r}):(0,t.jsx)(i.xu,{children:(0,t.jsx)(c.x,{children:"loading..."})})}}},function(e){e.O(0,[905,550,971,774,888,179],function(){return e(e.s=6698)}),_N_E=e.O()}]);