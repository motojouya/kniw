(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[973],{7156:function(e,t,r){(window.__NEXT_P=window.__NEXT_P||[]).push(["/battle",function(){return r(7243)}])},7243:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return pages_battle}});var i=r(5893),s=r(7294),l=r(9332),n=r(1817),a=r(4e3),c=r(8692),u=r(4359),o=r(193),h=r(5501),x=r(1664),d=r.n(x),j=r(5541),m=r(1039),p=r(2274);let BattleList=()=>{let{battleRepository:e}=(0,p.j)(),t=(0,m.useLiveQuery)(()=>e.list(),[]);return(0,i.jsxs)(n.xu,{children:[(0,i.jsx)(d(),{href:{pathname:"/"},children:(0,i.jsx)("a",{children:"戻る"})}),(0,i.jsx)(n.xu,{children:(0,i.jsxs)(j.aV,{children:[(0,i.jsx)(j.HC,{children:(0,i.jsx)(d(),{href:{pathname:"battle",query:{title:"__new"}},children:(0,i.jsx)("a",{children:"新しく作る"})})},"battle-new"),t&&t.map((e,t)=>(0,i.jsx)(j.HC,{children:(0,i.jsx)(d(),{href:{pathname:"battle",query:{title:e}},children:(0,i.jsx)("a",{children:e})})},"battle-".concat(t)))]})})]})};var f=r(1163),v=r(7536),w=r(1001),b=r(8020),S=r(6529),V=r(6479),I=r(4225),_=r(9631),g=r(6174),N=r(1614);let startBattle=e=>async(t,r,i,s)=>{let l=(0,g.DG)(t,r,i),n=(0,g.BL)(l,s,(0,N.NN)());l.turns.push(n);let a=(0,g.k_)(l);return l.turns.push((0,g.Dc)(l,a.restWt,s,(0,N.NN)())),await e.save(l),l},BattleNew=()=>{let{battleRepository:e}=(0,p.j)(),t=(0,f.useRouter)(),[r,l]=(0,s.useState)(""),{handleSubmit:c,register:u,formState:{errors:o,isSubmitting:h}}=(0,v.cI)(),[x,j]=(0,s.useState)(null),[m,g]=(0,s.useState)(null),start=async r=>{let i=[],{title:s}=r;if(s||i.push("titleを入力してください"),x||i.push("home partyを入力してください"),m||i.push("visitor partyを入力してください"),i.length>0){l(i.join("\n"));return}let n=await startBattle(e)(s,x,m,new Date);await t.push({pathname:"battle",query:{title:n.title}})};return(0,i.jsxs)(n.xu,{p:4,children:[(0,i.jsx)(d(),{href:{pathname:"battle"},children:(0,i.jsx)("a",{children:"戻る"})}),(0,i.jsx)(a.x,{children:"This is the battle page"}),(0,i.jsxs)("form",{onSubmit:c(start),children:[r&&(0,i.jsx)(w.J1,{children:r}),(0,i.jsxs)(b.NI,{isInvalid:!!o.title,children:[(0,i.jsx)(S.l,{htmlFor:"title",children:"title"}),(0,i.jsx)(V.I,{id:"title",placeholder:"title",...u("title")}),(0,i.jsx)(w.J1,{children:o.title&&o.title.message})]}),(0,i.jsx)(_.R,{type:"HOME",party:x,setParty:j}),(0,i.jsx)(_.R,{type:"VISITOR",party:m,setParty:g}),(0,i.jsx)(I.z,{colorScheme:"teal",isLoading:h,type:"submit",children:"Start Battle"})]})]})};var R=r(6312),k=r(1731),y=r(8371),E=r(2757),O=r(9677),C=r(1604),D=r(5340),T=r(4210),B=r(5043);let W="DO_NOTHING";let ReceiverDuplicationError=class ReceiverDuplicationError{constructor(e){this.message=e}};let H=C.z.object({skillName:C.z.string().min(1),receiversWithIsVisitor:C.z.array(C.z.object({value:C.z.string().min(1)}))}),receiverSelectOption=e=>({value:"".concat(e.name,"__").concat((0,T.oR)(e.isVisitor)),label:"".concat(e.name,"(").concat((0,T.oR)(e.isVisitor),")")}),toReceiver=(e,t)=>{let r=e.match(/^(.*)__(HOME|VISITOR)$/);if(!r)throw Error("no match");let i=r[1];if(!i)throw Error("no name");let s=r[2];if("HOME"!==s&&"VISITOR"!==s)throw Error("isVisitorStr must be HOME or VISITOR. (".concat(s,")"));let l="VISITOR"===s,n=t.find(e=>e.name===i&&e.isVisitor===l);return n||new D.Xs(i,"charactor","".concat(i,"というcharactorは存在しません"))},toAction=(e,t)=>{let{skillName:r}=e;if(r===W)return null;let i=B.U.get(r);if(!i)return new D.Xs(r,"skill","".concat(r,"というskillは存在しません"));let s=new Set(e.receiversWithIsVisitor.map(e=>e.value));if(s.size!==e.receiversWithIsVisitor.length)return new ReceiverDuplicationError("同じキャラクターを複数回えらべません");let l=[];for(let r of e.receiversWithIsVisitor){let e=toReceiver(r.value,t);if(e instanceof D.Xs)return e;l.push(e)}return{skill:i,receivers:l}};var L=r(20),X=r(3703),z=r(4510);let act=(e,t)=>async(r,i,s,l)=>{let n=toAction(s,l.sortedCharactors);if(n instanceof D.Xs||n instanceof ReceiverDuplicationError)return n;if(!e.confirm("実行していいですか？"))return new h.vW("Cancelされました");if(null===n)r.turns.push((0,g.en)(r,i,new Date));else{let e=n.skill,t="SKILL_TO_FIELD"===e.type?(0,g.d)(r,i,e,new Date,(0,N.NN)()):(0,g.B7)(r,i,e,n.receivers,new Date,(0,N.NN)());r.turns.push(t)}if(r.result=(0,g.fe)(r),r.result!==g.Ai)return await t.save(r),null;let a=(0,g.k_)(r);if(r.turns.push((0,g.Dc)(r,a.restWt,new Date,(0,N.NN)())),r.result=(0,g.fe)(r),r.result!==g.Ai)return await t.save(r),null;for(;(0,X.V)(z.sleep,a)&&(r.turns.push((0,g.en)(r,a,new Date)),r.result=(0,g.fe)(r),r.result===g.Ai&&(a=(0,g.k_)(r),r.turns.push((0,g.Dc)(r,a.restWt,new Date,(0,N.NN)())),r.result=(0,g.fe)(r),r.result===g.Ai)););return await t.save(r),null},surrender=(e,t)=>async(r,i,s)=>{if(!t.confirm("降参してもよいですか？"))return new h.vW("降参していません");let l=(0,g.mR)(r,i,s);return r.turns.push(l),await e.save({...r,result:i.isVisitor?g.ZV:g.Eh}),null},selectReceiver=(e,t,r,i,s,l)=>{let n=toReceiver(i,s.sortedCharactors);if(n instanceof D.Xs)return n;let a=(0,g.B7)(e,t,r,[n],l,(0,N.q6)()),c=a.sortedCharactors.find(e=>e.isVisitor===n.isVisitor&&e.name===n.name);return{receiver:n,survive:!!c}},skillReceiverCount=e=>{if(e===W)return 0;let t=B.U.get(e);return t&&t.receiverCount?t.receiverCount:0},GameResultView=e=>{let{battle:t}=e,r="".concat(t.home.name,"(HOME) vs ").concat(t.visitor.name,"(VISITOR)");switch(t.result){case g.ZV:return(0,i.jsx)(a.x,{children:"".concat(r," HOME側の勝利")});case g.Eh:return(0,i.jsx)(a.x,{children:"".concat(r," VISITOR側の勝利")});case g.$C:return(0,i.jsx)(a.x,{children:"".concat(r," 引き分け")});default:return(0,i.jsx)(a.x,{children:r})}},ReceiverSelect=e=>{let{battle:t,actor:r,lastTurn:l,skill:a,index:c,getValues:u,register:o}=e,h="receiversWithIsVisitor.".concat(c,".value"),[x,d]=(0,s.useState)(null),j=l.sortedCharactors.map(receiverSelectOption);return(0,i.jsxs)(n.xu,{children:[(0,i.jsxs)(b.NI,{children:[(0,i.jsx)(S.l,{htmlFor:h,children:"receiver"}),(0,i.jsx)(k.P,{...o(h,{onBlur:()=>{let e=u(h),i=selectReceiver(t,r,a,e,l,new Date);if(i instanceof D.Xs){d(null);return}let{survive:s,receiver:n}=i;if(!s){d("".concat(n.name," will dead"));return}d(n)}}),placeholder:"receiver",children:j.map(e=>(0,i.jsx)("option",{value:e.value,children:e.label},"".concat(e.value)))})]}),(0,i.jsx)(n.xu,{children:x&&("string"==typeof x?x:(0,i.jsx)(O.i,{charactor:x}))})]})},Surrender=e=>{let{battle:t,actor:r}=e,{battleRepository:s,dialogue:l}=(0,p.j)();return(0,i.jsx)(I.z,{type:"button",onClick:()=>surrender(s,l)(t,r,new Date),children:"降参"})},SkillSelect=e=>{let{actor:t,replace:r,getValues:s,register:l,errors:n}=e,a=(0,T.SM)(t),c=a.filter(e=>e.mpConsumption<=t.mp).filter(e=>!(0,X.V)(z.silent,t)||e.magicType===L.LB).map(e=>({value:e.name,label:e.name}));return c.push({value:W,label:"何もしない"}),(0,i.jsxs)(b.NI,{isInvalid:!!n.skillName,children:[(0,i.jsx)(S.l,{htmlFor:"skill",children:"skill"}),(0,i.jsx)(k.P,{...l("skillName",{onBlur:()=>{let e=s("skillName"),t=skillReceiverCount(e);r(Array(t).fill(""))}}),placeholder:"skill",children:c.map(e=>(0,i.jsx)("option",{value:e.value,children:e.label},"".concat(e.value)))}),(0,i.jsx)(w.J1,{children:!!n.skillName&&n.skillName.message})]})},BattleTurn=e=>{let{battle:t}=e,{battleRepository:r,dialogue:l}=(0,p.j)(),c=(0,g.aY)(t),u=(0,g.k_)(t),{handleSubmit:o,register:x,getValues:m,formState:{errors:f,isSubmitting:b},control:S}=(0,v.cI)({resolver:(0,R.F)(H)}),{fields:V,replace:_}=(0,v.Dq)({control:S,name:"receiversWithIsVisitor"}),[N,k]=(0,s.useState)(""),actSkill=async e=>{let i=await act(l,r)(t,u,e,c);if(i instanceof D.Xs){k("入力してください");return}if(i instanceof ReceiverDuplicationError||i instanceof h.vW){k(i.message);return}_([])},C=u.isVisitor?(0,i.jsx)(y.Vp,{children:"VISITOR"}):(0,i.jsx)(y.Vp,{children:"HOME"}),W=B.U.get(m("skillName"));return(0,i.jsxs)(n.xu,{p:4,children:[(0,i.jsx)(d(),{href:{pathname:"battle"},children:(0,i.jsx)("a",{children:"戻る"})}),(0,i.jsx)(a.x,{children:"This is the battle page"}),t.result!==g.Ai&&(0,i.jsx)(I.z,{type:"button",onClick:()=>r.exportJson(t,""),children:"Export"}),(0,i.jsx)(GameResultView,{battle:t}),t.result===g.Ai&&(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)("form",{onSubmit:o(actSkill),children:[N&&(0,i.jsx)(w.J1,{children:N}),t.result===g.Ai&&(0,i.jsx)(Surrender,{battle:t,actor:u}),(0,i.jsxs)(n.xu,{as:"dl",children:[(0,i.jsx)(E.X,{as:"dt",children:"battle title"}),(0,i.jsx)(a.x,{as:"dd",children:t.title})]}),(0,i.jsxs)(a.x,{children:["".concat(u.name,"のターン"),C]}),(0,i.jsx)(SkillSelect,{actor:u,getValues:m,register:x,errors:f,replace:_}),(0,i.jsx)(j.aV,{children:V.map((e,r)=>(0,i.jsx)(j.HC,{children:W&&(0,i.jsx)(ReceiverSelect,{battle:t,actor:u,lastTurn:c,skill:W,getValues:m,register:x,index:r})},"receiversWithIsVisitor.".concat(r)))}),(0,i.jsx)(I.z,{colorScheme:"teal",isLoading:b,type:"submit",children:"実行"})]}),(0,i.jsx)(n.xu,{children:(0,i.jsx)(j.aV,{children:c.sortedCharactors.map(e=>(0,i.jsx)(j.HC,{children:(0,i.jsx)(O.i,{charactor:e})},"CharactorDetail-".concat(e.name,"-").concat((0,T.oR)(e.isVisitor))))})})]})]})};var A=r(9671),M=r(2438);let BattleExsiting=e=>{let{battleTitle:t}=e,{battleRepository:r}=(0,p.j)(),s=(0,m.useLiveQuery)(()=>r.get(t),[t]);return s instanceof M.m||s instanceof D.Xs||s instanceof A.hi||s instanceof D.$b||s instanceof g.pZ?(0,i.jsxs)(n.xu,{children:[(0,i.jsx)(a.x,{children:s.message}),(0,i.jsx)(d(),{href:{pathname:"battle"},children:(0,i.jsx)("a",{children:"戻る"})})]}):s?(0,i.jsx)(BattleTurn,{battle:s}):(0,i.jsxs)(n.xu,{children:[(0,i.jsx)(d(),{href:{pathname:"battle"},children:(0,i.jsx)("a",{children:"戻る"})}),(0,i.jsx)(a.x,{children:"".concat(t,"というbattleは見つかりません")})]})};var pages_battle=()=>{let e=(0,l.useSearchParams)(),t=e.get("title"),[r,x]=(0,s.useState)(null);if((0,s.useEffect)(()=>{(async()=>{let e=await (0,o.a)(),t=await (0,u.h4)(e),r=await (0,c.h4)(e);x({partyRepository:t,battleRepository:r})})()},[]),!r)return(0,i.jsx)(n.xu,{children:(0,i.jsx)(a.x,{children:"loading..."})});let d={...r,dialogue:h.OR};return t?"__new"===t?(0,i.jsx)(p._,{io:d,children:(0,i.jsx)(BattleNew,{})}):(0,i.jsx)(p._,{io:d,children:(0,i.jsx)(BattleExsiting,{battleTitle:t})}):(0,i.jsx)(p._,{io:d,children:(0,i.jsx)(BattleList,{})})}}},function(e){e.O(0,[905,154,974,774,888,179],function(){return e(e.s=7156)}),_N_E=e.O()}]);